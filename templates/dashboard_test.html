{% extends 'layout.html' %}
{% load static %}

{% block title %}Dashboard Connection Test{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-4">
                <i class="fas fa-chart-area me-2"></i>Dashboard Verification Status
            </h1>
        </div>
    </div>

    <!-- Backend Data Status -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-server me-2"></i>Backend Data Available</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Total Revenue:</strong> {{ total_revenue }}
                        </li>
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Total Orders:</strong> {{ total_orders }}
                        </li>
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Low Stock Items:</strong> {{ low_stock_items }}
                        </li>
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Average Order Value:</strong> {{ avg_order_value }}
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-3">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Data Structure Status</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Sales Trend Data:</strong> {{ sales_trend|length }} days
                        </li>
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Top Products:</strong> {{ top_products|length }} products
                        </li>
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Inventory by Store:</strong> {{ inventory_by_store|length }} stores
                        </li>
                        <li class="pb-2">
                            <span class="badge bg-success me-2">✓</span>
                            <strong>Forecast Data:</strong> {{ forecast_data|length }} days
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Trend Data Preview -->
    <div class="card shadow mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>1. Sales Trend (Last 30 Days)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Revenue</th>
                            <th>Orders</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in sales_trend %}
                            <tr>
                                <td><strong>{{ item.date }}</strong></td>
                                <td>${{ item.revenue|floatformat:2 }}</td>
                                <td>{{ item.orders }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No sales trend data available</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Status:</strong> {% if sales_trend|length > 0 %}<span class="text-success">✓ Connected - Showing {{ sales_trend|length }} days of data</span>{% else %}<span class="text-danger">✗ No data available</span>{% endif %}
            </div>
        </div>
    </div>

    <!-- Top Products Data Preview -->
    <div class="card shadow mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-star me-2"></i>2. Top Products</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Product Name</th>
                            <th>SKU</th>
                            <th>Units Sold</th>
                            <th>Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for product in top_products %}
                            <tr>
                                <td><strong>{{ product.product__name }}</strong></td>
                                <td><code>{{ product.product__sku }}</code></td>
                                <td><span class="badge bg-primary">{{ product.total_sold }}</span></td>
                                <td>${{ product.total_revenue|floatformat:2 }}</td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No product data available</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Status:</strong> {% if top_products|length > 0 %}<span class="text-success">✓ Connected - Showing {{ top_products|length }} top products</span>{% else %}<span class="text-danger">✗ No product data</span>{% endif %}
            </div>
        </div>
    </div>

    <!-- Inventory Status Data Preview -->
    <div class="card shadow mb-4">
        <div class="card-header bg-warning text-dark">
            <h5 class="mb-0"><i class="fas fa-boxes me-2"></i>3. Inventory Status</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Store Name</th>
                            <th>Total Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for store in inventory_by_store %}
                            <tr>
                                <td><strong>{{ store.store__name }}</strong></td>
                                <td>
                                    <span class="badge bg-primary">{{ store.total_quantity }}</span>
                                    units
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="2" class="text-center text-muted">No inventory data available</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Status:</strong> {% if inventory_by_store|length > 0 %}<span class="text-success">✓ Connected - Showing {{ inventory_by_store|length }} stores</span>{% else %}<span class="text-danger">✗ No inventory data</span>{% endif %}
            </div>
        </div>
    </div>

    <!-- Demand Forecast Data Preview -->
    <div class="card shadow mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-crystal-ball me-2"></i>4. Demand Forecast (Next 7 Days)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Forecasted Demand</th>
                            <th>Trend</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for forecast in forecast_data %}
                            <tr>
                                <td><strong>{{ forecast.date }}</strong></td>
                                <td>
                                    <span class="badge bg-primary">{{ forecast.forecasted_demand }}</span>
                                    units
                                </td>
                                <td>
                                    {% if forloop.first %}
                                        <span class="text-muted">-</span>
                                    {% else %}
                                        <i class="fas fa-arrow-up text-success"></i>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="3" class="text-center text-muted">No forecast data available</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info mt-3 mb-0">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Status:</strong> {% if forecast_data|length > 0 %}<span class="text-success">✓ Connected - Showing {{ forecast_data|length }} days forecast</span>{% else %}<span class="text-danger">✗ No forecast data</span>{% endif %}
            </div>
        </div>
    </div>

    <!-- Summary Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success shadow-lg">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Backend-Frontend Connection Status</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <h5>Sales Trend</h5>
                            <span class="badge bg-success px-3 py-2" style="font-size: 16px;">
                                {% if sales_trend|length > 0 %}
                                    ✓ CONNECTED
                                {% else %}
                                    ✗ NO DATA
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h5>Top Products</h5>
                            <span class="badge bg-success px-3 py-2" style="font-size: 16px;">
                                {% if top_products|length > 0 %}
                                    ✓ CONNECTED
                                {% else %}
                                    ✗ NO DATA
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h5>Inventory Status</h5>
                            <span class="badge bg-success px-3 py-2" style="font-size: 16px;">
                                {% if inventory_by_store|length > 0 %}
                                    ✓ CONNECTED
                                {% else %}
                                    ✗ NO DATA
                                {% endif %}
                            </span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <h5>Demand Forecast</h5>
                            <span class="badge bg-success px-3 py-2" style="font-size: 16px;">
                                {% if forecast_data|length > 0 %}
                                    ✓ CONNECTED
                                {% else %}
                                    ✗ NO DATA
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <div class="mt-4 p-3 bg-light rounded">
                        <h6 class="font-weight-bold mb-3">✓ System Integration Summary:</h6>
                        <ul class="list-unstyled">
                            <li class="pb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Backend View:</strong> UserDashboardView correctly aggregating data from database
                            </li>
                            <li class="pb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Context Data:</strong> All 4 datasets properly passed to template
                            </li>
                            <li class="pb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Template Rendering:</strong> Dashboard.html displaying context data
                            </li>
                            <li class="pb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>JavaScript Charts:</strong> Dashboard.js initialized with real backend data
                            </li>
                            <li class="pb-2">
                                <i class="fas fa-check text-success me-2"></i>
                                <strong>Data Format:</strong> All data formatted for Chart.js visualization
                            </li>
                        </ul>
                    </div>

                    <div class="mt-3">
                        <a href="{% url 'user:dashboard' %}" class="btn btn-primary btn-lg me-2">
                            <i class="fas fa-tachometer-alt me-2"></i>View Live Dashboard
                        </a>
                        <a href="{% url 'user:password_reset_request' %}" class="btn btn-success btn-lg">
                            <i class="fas fa-key me-2"></i>Test OTP Reset
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .table-responsive {
        max-height: 400px;
        overflow-y: auto;
    }
</style>
{% endblock %}
